{% extends "layout.html" %} {% block content %}
<div class="container py-5">
  <div class="card shadow-lg mx-auto" style="max-width: 600px">
    <div class="card-body">
      <h2 class="card-title text-center mb-4">{{ question.question }}</h2>

      {% if question.get('image') %}
      <img
        src="{{ question.image }}"
        class="img-fluid mb-3 d-block mx-auto"
        alt="Chord Image"
        width="300"
      />
      {% endif %}

      {% if question.get('audio') %}
      <div class="text-center mb-3">
        <audio controls>
          <source src="{{ question.audio }}" type="audio/mpeg" />
          Your browser does not support the audio element.
        </audio>
      </div>
      {% endif %}

      <form method="POST" action="{{ url_for('submit_quiz') }}" id="quizForm">
        {% if question.type == 'drag_drop' %}
        <div class="fret-diagram-container mb-4">
          <div class="finger-circles" id="fingerCircles">
            <!-- Draggable finger circles will be here -->
          </div>
          <div class="fret-diagram" id="fretDiagram">
            <!-- Fret diagram will be rendered here -->
          </div>
        </div>
        {% else %}
        {% for option in question.options %}
        <div class="form-check mb-2">
          <input
            class="form-check-input"
            type="radio"
            name="answer"
            value="{{ option }}"
            id="option{{ loop.index }}"
            required
          />
          <label class="form-check-label" for="option{{ loop.index }}">
            {{ option }}
          </label>
        </div>
        {% endfor %}
        {% endif %}

        <input type="hidden" name="correct" value="{{ question.correct }}" />
        <input type="hidden" name="quiz_id" value="{{ quiz_id }}" />
        <input type="hidden" name="finger_positions" id="fingerPositions" value="" />
        <input type="hidden" name="question_type" value="{{ question.type }}" />

        <div id="feedback" class="text-center mb-3"></div>

        <div class="text-center mt-4">
          <a
            href="javascript:history.back()"
            class="btn btn-sm mr-2"
            style="background-color: #b2d8b2; color: #2c3e50"
          >
            ← Go Back
          </a>
          <button type="submit" class="btn btn-primary btn-lg">
            Submit Answer
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- progress bar -->
  <div class="mt-4">
    <div class="progress" style="height: 25px">
      <div
        class="progress-bar progress-bar-striped progress-bar-animated bg-info"
        role="progressbar"
        style="width: {{ progress }}%;"
        aria-valuenow="{{ progress }}"
        aria-valuemin="0"
        aria-valuemax="100"
      >
        {{ progress }}%
      </div>
    </div>
  </div>
</div>

<style>
.fret-diagram-container {
  position: relative;
  width: 300px;
  margin: 0 auto;
}

.fret-diagram {
  width: 100%;
  height: 200px;
  background-color: #f8f9fa;
  border: 2px solid #2c3e50;
  position: relative;
}

.finger-circle {
  width: 30px;
  height: 30px;
  background-color: #3498db;
  border-radius: 50%;
  position: absolute;
  cursor: move;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  user-select: none;
}

.finger-circles {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  gap: 10px;
}

.string {
  position: absolute;
  width: 2px;
  height: 100%;
  background-color: #2c3e50;
}

.fret {
  position: absolute;
  height: 2px;
  width: 100%;
  background-color: #2c3e50;
}
</style>

<script src="{{ url_for('static', filename='js/fret-diagram.js') }}"></script>

<script>
function checkAnswerAndFeedback() {
    const validStrings = [2, 3, 4];
    const validFret = 1; // 2nd fret (between 1st and 2nd fret lines)
    const stringWidth = fretDiagram.offsetWidth / 5;
    const fretHeight = fretDiagram.offsetHeight / 5;
    const circles = fretDiagram.querySelectorAll('.finger-circle');
    let correctCount = 0;
    let feedbackMsg = '';
    let foundStrings = [];

    circles.forEach(circle => {
        // Remove previous feedback
        circle.style.border = '';
        circle.style.backgroundColor = '#3498db';

        const x = parseInt(circle.style.left);
        const y = parseInt(circle.style.top);
        const string = Math.round(x / stringWidth);
        const fret = Math.floor(y / fretHeight);

        if (validStrings.includes(string) && fret === validFret && !foundStrings.includes(string)) {
            circle.style.border = '3px solid #28a745'; // green border for correct
            correctCount++;
            foundStrings.push(string);
        } else {
            circle.style.border = '3px solid #dc3545'; // red border for incorrect
            circle.style.backgroundColor = '#dc3545';
            feedbackMsg += `• Incorrect placement on string ${string + 1}, fret ${fret + 1}<br>`;
        }
    });

    const feedback = document.getElementById('feedback');
    if (feedback) {
        if (correctCount === 3 && circles.length === 3) {
            feedback.innerHTML = '✅ Correct! Great job!';
            feedback.style.color = '#28a745';
        } else {
            feedback.innerHTML = '❌ Not quite!<br>' + feedbackMsg;
            feedback.style.color = '#dc3545';
        }
    }
}
</script>
{% endblock %}
